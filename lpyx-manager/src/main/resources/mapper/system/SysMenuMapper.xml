<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wink.lpyx.manager.mapper.system.SysMenuMapper">

    <!--  映射查询到的字段 -->
    <resultMap id="SysMenuMap" type="com.wink.lpyx.model.entity.system.SysMenu">
        <result property="parentId" column="parent_id"/>
        <result property="title" column="title"/>
        <result property="component" column="component"/>
        <result property="sortValue" column="sort_value"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
        id,parent_id,title,component,sort_value,status,create_time,update_time,is_deleted
    </sql>


    <insert id="saveSysMenu">
        insert into sys_menu(id, parent_id, title, component, sort_value, status, create_time, update_time, is_deleted)
            value (#{id}, #{parentId}, #{title}, #{component}, #{sortValue}, #{status}, now(), now(), 0)
    </insert>

    <update id="updateSysMenu">
        update sys_menu
        set
        <if test="parentId != null and parentId != ''">
            parent_id = #{parentId},
        </if>
        <if test="title != null and title != ''">
            title = #{title},
        </if>
        <if test="component != null and component != ''">
            component = #{component},
        </if>
        <if test="sortValue != null and sortValue != ''">
            sort_value = #{sortValue},
        </if>
        <if test="status != null and status != ''">
            status = #{status},
        </if>
        update_time = now()
        where id = #{id}
    </update>

    <delete id="removeById">
        update sys_menu
        set is_deleted = 1
        <where>
            id = #{id}
        </where>
    </delete>


    <select id="findAll" resultMap="SysMenuMap">
        select
        <include refid="columns"/>
        from sys_menu
        where is_deleted = 0
        order by sort_value
    </select>

    <select id="findChildCountById" resultType="java.lang.Integer">
        select count(*)
        from sys_menu
        where parent_id = #{id}
          and is_deleted = 0
    </select>


    <select id="findMenusByUserId" resultMap="SysMenuMap">
        select distinct m.*
        from sys_menu m
                 left join sys_role_menu rm on m.id = rm.menu_id
                 left join sys_user_role ur on rm.role_id = ur.role_id
        where m.is_deleted = 0
          and ur.user_id = #{userId}
          and m.status = 1
        order by m.sort_value
    </select>


</mapper>